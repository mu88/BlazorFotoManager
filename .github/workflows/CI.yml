name: Combined CI / Release

on:
  workflow_dispatch:
  push:
    branches:
      - '**'

jobs:
  shared_ci_cd:
    permissions:
      contents: read

    uses: mu88/github-actions/.github/workflows/ci-cd.yml@a27cb31c1879dcec13765ac01bb315041dc5ad86
    with:
      dotnet-cache-dependencies-via-lock-file: false # by default, NuGet lock files are used. However, ElectronNET seem to have issues with that
      sonar-key: mu88_BlazorFotoManager
    secrets:
      sonar-token: ${{ secrets.SONAR_TOKEN }}

  ci_cd:
    runs-on: windows-latest

    needs: shared_ci_cd

    permissions:
      attestations: write
      contents: read
      id-token: write

    steps:
    - name: Check out code
      uses: actions/checkout@v5

    - name: Set up .NET
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: global.json

    - name: Restore .NET tools
      run: dotnet tool restore

    - name: Determine version (release or non-release)
      id: determine_version
      shell: pwsh
      run: |
        if ('${{ needs.shared_ci_cd.outputs.is_release }}' -eq 'true') {
          Write-Host "Release version is already set to ${{ needs.shared_ci_cd.outputs.release_version }}"
          Write-Output "version=${{ needs.shared_ci_cd.outputs.release_version }}" >> $env:GITHUB_OUTPUT
        } else {
          $devVersion = "0.0.1"
          Write-Host "Setting release version to dev version $devVersion"
          Write-Output "version=$devVersion" >> $env:GITHUB_OUTPUT
        }

    - name: Build Windows app with ElectronNET
      run: dotnet publish FotoManager\FotoManager.csproj -p:PublishProfile=win-x64 -p:Version=${{ steps.determine_version.outputs.version }}

    - name: Determine release notes
      id: changelog
      if: ${{ needs.shared_ci_cd.outputs.is_release == 'true' }}
      run: |
        # See https://github.com/versionize/versionize/issues/189: Versionize requires git user config to be set
        git config user.name "John Doe"
        git config user.email "johndoe@example.com"

        dotnet tool restore
        dotnet tool run versionize --skip-dirty --dry-run changelog -v ${{ needs.shared_ci_cd.outputs.release_version }} >> ${{ runner.temp }}/release_notes.md || true
        release_notes=$(cat ${{ runner.temp }}/release_notes.md)
        echo "Determined release notes:"
        echo "$release_notes"
        if [ -z "$release_notes" ]; then
          echo "No release notes determined, something went wrong."
          exit 1
        fi

        # Use GitHub Actions multiline output syntax to safely pass release notes (they may contain newlines and lines starting with '*')
        echo "changes<<EOF" >> $GITHUB_OUTPUT
        cat ${{ runner.temp }}/release_notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Attest build provenance
      uses: actions/attest-build-provenance@v3
      if: ${{ needs.shared_ci_cd.outputs.is_release == 'true' }}
      with:
        subject-path: FotoManager/publish/bin/FotoFlipper_${{ steps.determine_version.outputs.version }}.exe

    - name: Generate SBOM
      uses: anchore/sbom-action@v0
      with:
        output-file: sbom.json
        path: .

    - name: Attest SBOM
      uses: actions/attest-sbom@v2
      if: ${{ needs.shared_ci_cd.outputs.is_release == 'true' }}
      with:
        sbom-path: sbom.json
        subject-path: FotoManager/publish/bin/FotoFlipper_${{ steps.determine_version.outputs.version }}.exe

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      if: ${{ needs.shared_ci_cd.outputs.is_release == 'true' }}
      with:
        files: |
          sbom.json
          FotoManager/publish/bin/FotoFlipper*.exe
        name: ${{ needs.shared_ci_cd.outputs.release_version }}
        tag_name: ${{ needs.shared_ci_cd.outputs.release_version }}
        body: ${{ steps.changelog.outputs.changes }}
