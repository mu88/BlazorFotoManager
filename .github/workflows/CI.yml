name: Combined CI / Release

on:
  workflow_dispatch:
  push:
    branches:
      - '**'

jobs:
  shared_ci_cd:
    permissions:
      contents: read

    uses: mu88/github-actions/.github/workflows/ci-cd.yml@a27cb31c1879dcec13765ac01bb315041dc5ad86
    with:
      dotnet-cache-dependencies-via-lock-file: false # by default, NuGet lock files are used. However, ElectronNET seem to have issues with that
      sonar-key: mu88_BlazorFotoManager
    secrets:
      sonar-token: ${{ secrets.SONAR_TOKEN }}

  ci_cd:
    runs-on: windows-latest

    needs: shared_ci_cd

    permissions:
      attestations: write
      contents: read
      id-token: write

    steps:
    - name: Check out code
      uses: actions/checkout@v5

    - name: Set up .NET
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: global.json

    - name: Restore .NET tools
      run: dotnet tool restore

    - name: Determine version (release or non-release)
      id: determine_version
      shell: pwsh
      run: |
        if ('${{ needs.shared_ci_cd.outputs.is_release }}' -eq 'true') {
          Write-Host "Release version is already set to ${{ needs.shared_ci_cd.outputs.release_version }}"
          Write-Output "version=${{ needs.shared_ci_cd.outputs.release_version }}" >> $env:GITHUB_OUTPUT
        } else {
          $devVersion = "0.0.1"
          Write-Host "Setting release version to dev version $devVersion"
          Write-Output "version=$devVersion" >> $env:GITHUB_OUTPUT
        }

    - name: Build Windows app with ElectronNET
      run: dotnet publish FotoManager\FotoManager.csproj -p:PublishProfile=win-x64 -p:Version=${{ steps.determine_version.outputs.version }}

    - name: Determine release notes
      id: changelog
      if: ${{ needs.shared_ci_cd.outputs.is_release == 'true' }}
      run: |
        $release_notes = dotnet tool versionize changelog -v ${{ needs.shared_ci_cd.outputs.release_version }}
        if [ -z "$release_notes" ]; then
          echo "No release notes generated, something went wrong."
          exit 1
        fi

        echo "changes=$release_notes" >> $GITHUB_OUTPUT

    - name: Attest build provenance
      uses: actions/attest-build-provenance@v3
      if: ${{ needs.shared_ci_cd.outputs.is_release == 'true' }}
      with:
        subject-path: FotoManager/publish/bin/FotoFlipper_${{ steps.determine_version.outputs.version }}.exe

    - name: Generate SBOM
      uses: anchore/sbom-action@v0
      with:
        output-file: sbom.json
        path: .

    - name: Attest SBOM
      uses: actions/attest-sbom@v2
      if: ${{ needs.shared_ci_cd.outputs.is_release == 'true' }}
      with:
        sbom-path: sbom.json
        subject-path: FotoManager/publish/bin/FotoFlipper_${{ steps.determine_version.outputs.version }}.exe

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      if: ${{ needs.shared_ci_cd.outputs.is_release == 'true' }}
      with:
        files: |
          sbom.json
          FotoManager/publish/bin/FotoFlipper*.exe
        name: ${{ needs.shared_ci_cd.outputs.release_version }}
        tag_name: ${{ needs.shared_ci_cd.outputs.release_version }}
        body: ${{ steps.changelog.outputs.changes }}
