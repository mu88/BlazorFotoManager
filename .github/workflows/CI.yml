name: Combined CI / Release

on:
  workflow_dispatch:
  push:
    branches:
      - '**'

jobs:
  shared_ci_cd:
    permissions:
      contents: read

    uses: mu88/github-actions/.github/workflows/ci-cd.yml@9e69b372885aa30566ebf1dbfa0611e4b66294e9
    with:
      dotnet-cache-dependencies-via-lock-file: false # by default, NuGet lock files are used. However, ElectronNET seem to have issues with that
      sonar-key: mu88_BlazorFotoManager
    secrets:
      sonar-token: ${{ secrets.SONAR_TOKEN }}

  ci_cd:
    runs-on: windows-latest

    needs: shared_ci_cd

    steps:
    - name: Check out code
      uses: actions/checkout@v5

    - name: Set up .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '6.0.x'
        global-json-file: global.json

    - name: Restore .NET tools
      run: dotnet tool restore

    - name: Determine version (release or non-release)
      id: determine_version
      shell: powershell
      run: |
        if ('${{ needs.shared_ci_cd.outputs.is_release }}' -eq 'true') {
            Write-Host "Release version is already set to ${{ needs.shared_ci_cd.outputs.release_version }}"
            echo "version=${{ needs.shared_ci_cd.outputs.release_version }}" >> $env:GITHUB_OUTPUT
        } else {
            $devVersion = "0.0.1"
            Write-Host "Setting release version to dev version $devVersion"
            echo "version=$devVersion" >> $env:GITHUB_OUTPUT
        }

    - name: Build Windows app with ElectronNET
      run: |
        pushd FotoManager
        dotnet tool run electronize build /target win /Version ${{ steps.determine_version.outputs.version }}
        popd

    - name: Determine release notes
      id: changelog
      if: ${{ needs.shared_ci_cd.outputs.is_release == 'true' }}
      run: |
        dotnet tool restore

        $release_notes = dotnet tool versionize changelog -v ${{ needs.shared_ci_cd.outputs.release_version }}
        if [ -z "$release_notes" ]; then
          echo "No release notes generated, something went wrong."
          exit 1
        fi

        echo "changes=$release_notes" >> $GITHUB_OUTPUT

    - name: Attest build provenance
      uses: actions/attest-build-provenance@v3
      if: ${{ needs.shared_ci_cd.outputs.is_release == 'true' }}
      with:
        subject-path: FotoManager/bin/Desktop/FotoFlipper*.exe

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      if: ${{ needs.shared_ci_cd.outputs.is_release == 'true' }}
      with:
        files: FotoManager/bin/Desktop/FotoFlipper*.exe # forward slashes MUST be used here, otherwise no artifacts will be found
        name: ${{ needs.shared_ci_cd.outputs.release_version }}
        tag_name: ${{ needs.shared_ci_cd.outputs.release_version }}
        body: ${{ steps.changelog.outputs.changes }}
